name: build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - name: Install libaio & lcov
      run: sudo apt-get install -y libaio1 libaio-dev lcov
    - name: Checkout repository
      uses: actions/checkout@v4
    - name: Setup Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        components: llvm-tools      
    - name: Install grcov
      run: cargo install grcov
    - name: Build and Test (default features)
      env:
        RUSTFLAGS: "-Cinstrument-coverage -Ctarget-cpu=native"
        LLVM_PROFILE_FILE: "coverage/default/coverage-%p-%m.profraw"
        CARGO_TARGET_DIR: "target/coverage-default"
      run: |
        mkdir -p coverage/default
        cargo build --verbose --all
        cargo test --verbose --all
    - name: Generate coverage report (default features)
      run: |
        grcov . \
          --binary-path ./target/coverage-default/debug/ \
          -s . -t lcov \
          --branch --ignore-not-existing \
          --ignore "target/" \
          --ignore "/home/runner/.cargo/registry/*" \
          --ignore "/home/runner/.cargo/git/*" \
          --ignore "*/.cargo/registry/*" \
          --ignore "*/.cargo/git/*" \
          --ignore "doradb-tpch-tests" \
          -o lcov.default.info
    - name: Build and Test (no-default-features)
      env:
        RUSTFLAGS: "-Cinstrument-coverage -Ctarget-cpu=native"
        LLVM_PROFILE_FILE: "coverage/no-default/coverage-%p-%m.profraw"
        CARGO_TARGET_DIR: "target/coverage-no-default"
      run: |
        mkdir -p coverage/no-default
        cargo build --verbose --all --no-default-features
        cargo test --verbose --all --no-default-features
    - name: Generate coverage report (no-default-features)
      run: |
        grcov . \
          --binary-path ./target/coverage-no-default/debug/ \
          -s . -t lcov \
          --branch --ignore-not-existing \
          --ignore "target/" \
          --ignore "/home/runner/.cargo/registry/*" \
          --ignore "/home/runner/.cargo/git/*" \
          --ignore "*/.cargo/registry/*" \
          --ignore "*/.cargo/git/*" \
          --ignore "doradb-tpch-tests" \
          -o lcov.no-default.info
    - name: Merge coverage reports
      run: |
        lcov -a lcov.default.info -a lcov.no-default.info -o lcov.info
    - name: Upload to codecov.io
      uses: codecov/codecov-action@v3
      with:
        file: lcov.info
        token: ${{secrets.CODECOV_TOKEN}}
